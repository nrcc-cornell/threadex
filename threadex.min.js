var latest_version_directory="data/v19.2",prev_version_directory="data/v18.3";function postSuccess(t,e){$("#progressbar").hide(),t?t.error?alert(t.error):e(t):alert}function postError(){$("#progressbar").hide(),alert("Error processing request; please try again")}function postResults(t,e,a){var r,n,s="https://data.rcc-acis.org"+e;window.XDomainRequest?((r=new XDomainRequest).open("GET",s+"?params="+JSON.stringify(t)),r.onload=function(){postSuccess(JSON.parse(r.responseText),a)},r.onerror=postError,r.onprogress=function(){},r.ontimeout=function(){},setTimeout(function(){r.send()},0)):(n={params:JSON.stringify(t),output:"json"},$.ajax(s,{type:"POST",data:n,dataType:"json",crossDamain:!0,success:function(t){postSuccess(t,a)},error:postError}))}function urlopts(){var t,e,a={},r=["himaxt","lomaxt","himint","lomint","hipcpn","archivehimaxt","archivelomaxt","archivehimint","archivelomint","archivehipcpn","changes","covmaxt","covmint","covpcpn","thread"],n=window.location.search.slice(1).split("&");for(t=0;t<n.length;t+=1)("thr_id"===(e=n[t].split("="))[0]&&(6===e[1].length||8===e[1].length)||"variable"===e[0]&&$.inArray(e[1].toLowerCase(),r)>=0)&&(a[e[0]]=e[1]);return a}function fixTraces(t){var e,a,r,n,s,i=$("#selected_report").text(),o=t.meta.valid_daterange[0],d=function(t){return t%4==0&&t%100!=0||t%400==0},l=function(t){var e,a,r,n,s,i,o,d=[],l=[],p=[],c=$.grep(t.data,function(t,e){return t[0].search("-02-29")>0});for(c.length&&(t.data=c),e=t.data.length-1;e>=0;e-=1)r=t.data[e][0],"T"===(n=t.data[e][1])?d.push([n,r]):"0.00"===n?l.push([n,r]):"M"!=n&&p.push([n,r]);for($.merge($.merge(p,d),l),a=0;a<=2;a+=1)"0.00"!==(i=p.shift())[0]&&"T"!==i[0]||(o=("T"===i[0]?"Trace":i[0])+" in "+i[1].slice(0,4),s=i[1].split("-"),2===a&&p.shift()[0]===i[0]&&(o+="+"),$("#results_table tbody tr td").filter(function(){return $(this).text()===parseInt(s[1])+"/"+parseInt(s[2])}).closest("tr").find("td").eq(a+1).text(o))};if(i.search("precipitation")>=0)for(e=0;e<366;e+=1)if("0.00"===(a=t.smry[0][e])[2][0]||"T"===a[2][0]){if(r=a[0][1].split("-"),n=parseInt(o[0].split("-")[0]),s=parseInt(o[1].split("-")[0]),2===parseInt(r[1])&&29===parseInt(r[2])){for(;!d(n);)n-=1;for(;!d(s);)s+=1}postResults({sid:$("#thr_id").val(),sdate:n.toString()+"-"+r[1]+"-"+r[2],edate:s.toString()+"-"+r[1]+"-"+r[2],elems:[{name:"pcpn",interval:[1,0,0],duration:1}],meta:[]},"/StnData",l)}}function addGraph(t,e){$("#results_area").append('<div id="chart-container"></div>'),Highcharts.chart("chart-container",{chart:{type:"columnrange",inverted:!0,zoomType:"xy",spacingBottom:20,borderWidth:1},title:{text:"Range Between 1st and 3rd Record Values",style:{fontSize:"14px"}},subtitle:{text:"Click and drag to zoom in"},credits:{text:"Powered by ACIS",href:"https://www.rcc-acis.org"},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %e"},gridLineWidth:1,showLastLabel:!1},yAxis:{title:{text:e},floor:e.search("precipitation")>=0?0:null},legend:{enabled:!1},tooltip:{dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %e"},valueDecimals:e.search("precipitation")>=0?2:0,formatter:function(){var t=e.search("temperature")>=0?Math.round(this.point.low):this.point.low,a=e.search("temperature")>=0?Math.round(this.point.high):this.point.high;return"Range of records for "+Highcharts.dateFormat("%b %e",new Date(this.x))+": "+t+" to "+a}},series:[{name:"Range of records",data:t,pointStart:Date.UTC(2016,0,1),pointInterval:864e5}]})}function addToGraphSeries(t,e,a){var r=t.length>0?t[0][0]:null,n=t.length>1?t[1][0]:null,s=r,i=(t.length>2?t[2][0]:null)||n||r;return s?s===i&&a.search("temperature")>=0?a.search("Highest")>=0?e.push([parseFloat(s)+.2,parseFloat(i)-.2]):e.push([parseFloat(s)-.2,parseFloat(i)+.2]):(s=a.search("precipitation")>=0&&("T"===s||"Trace"===s)?0:parseFloat(s),i=a.search("precipitation")>=0&&("T"===i||"Trace"===i)?0:parseFloat(i),e.push([s,i])):e.push([null,null]),e}function displayRecords(t){var e,a,r,n,s,i,o,d,l,p,c=!1,h=t.meta,u=$("#selected_report").text(),m=u+(u.search("temperature")>=0?" (degrees F)":" (inches)"),g=[];for($("#results_area").append('<table id="results_table" class="abreast"><caption></caption><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#results_table caption").append(h.name+", "+h.state+'<br /><span class="subcaption">Period of record: '+h.valid_daterange[0][0]+" through "+h.valid_daterange[0][1]+"</span>"),$("#results_table thead").append("<tr><th rowspan=2>Date<th colspan=3>"+m+"</tr><tr><th>Top Record <th>2nd Record <th>3rd Record</tr>"),e=0;e<366;e+=1)(a=t.smry[0][e]).length>0&&(o=a.length>0?a[0]:["-","   -"],d=a.length>1?a[1]:["-","   -"],l=a.length>2?a[2]:["-","   -"],p=a.length>3?a[3]:["-","   -"],r=o[1].split("-"),s=parseInt(r[1])%2==1?"WhiteSmoke":"white","-"!==l[0]&&l[0]===p[0]?(i="+",c=!0):i="",n='<tr style="background-color: '+s+';"><td>'+parseInt(r[1])+"/"+parseInt(r[2]),n+="<td>"+("T"===o[0]||"0.00"===o[0]?"processing":o[0]+" in "+o[1].slice(0,4)),n+="<td>"+("T"===d[0]||"0.00"===d[0]?"processing":d[0]+" in "+d[1].slice(0,4)),n+="<td>"+("T"===l[0]||"0.00"===l[0]?"processing":l[0]+" in "+l[1].slice(0,4)+i)+"</tr>",$("#results_table tbody").append(n)),g=addToGraphSeries(a,g,m);c&&$("#results_area tfoot").append("<tr><td colspan=4>+ indicates same value also occurred in a previous year.</tr>"),fixTraces(t),addGraph(g,m)}function displayCoverage(t){var e,a,r,n,s,i,o,d=t.meta,l=t.data,p=$("#selected_report").text().replace("data coverage"," - Missing days per month"),c=function(t,e){return new Date(parseInt(t),e+1,0).getDate()};for($("#results_area").append('<table id="results_table" class="coverage_table"><caption></caption><thead></thead><tbody></tbody></table>'),$("#results_table caption").append(d.name+", "+d.state),$("#results_table thead").append("<tr><th rowspan=2>Year<th colspan=12>"+p+"</tr><tr><th>Jan<th>Feb<th>Mar<th>Apr<th>May<th>Jun<th>Jul<th>Aug<th>Sep<th>Oct<th>Nov<th>Dec</tr>"),e=0;e<l.length;e+=1){for(o=l[e][0],r=l[e][1],i="",a=0;a<12;a+=1)"M"===r[a]?(n=c(o,a),s="red"):0===r[a][1]?(n="-",s="green"):(n=r[a][1],s=r[a][1]===c(o,a)?"red":"yellow"),i+='<td style="background-color:'+s+';">'+n+"</td>";$("#results_table tbody").append("<tr><td>"+o+"</td>"+i+"</tr>")}}function displayArchiveRecords(t,e,a){var r,n,s,i,o,d,l=!1,p=$("#report").val(),c=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - "),h=$("#selected_report").text(),u=h+(h.search("temperature")>=0?" (degrees F)":" (inches)"),m=[];for($("#results_area").append('<table id="results_table" class="abreast"><caption></caption><thead></thead><tbody></tbody><tfoot></tfoot></table>'),$("#results_table caption").append(c[1]+" Area, "+c[0]+'<br /><span class="subcaption">Version: '+e+" (created "+a+')</span><br /><span class="subcaption">Period of record: '+t.start_yr+" through "+t.end_yr+"</span>"),$("#results_table thead").append("<tr><th rowspan=2>Date<th colspan=3>"+u+"</tr><tr><th>Top Record <th>2nd Record <th>3rd Record</tr>"),r=0;r<366;r+=1)s=(n=t.data[r])[0][1].split("-"),o=parseInt(s[1])%2==1?"WhiteSmoke":"white",n[3]?(d="+",l=!0):d="","archivehipcpn"===p&&(n[0][0]=-1===n[0][0]?"Trace":n[0][0].toFixed(2),n[1][0]=-1===n[1][0]?"Trace":n[1][0].toFixed(2),n[2][0]=-1===n[2][0]?"Trace":n[2][0].toFixed(2)),i='<tr style="background-color: '+o+';"><td>'+parseInt(s[1])+"/"+parseInt(s[2]),i+="<td>"+n[0][0]+" in "+s[0],i+="<td>"+n[1][0]+" in "+n[1][1].slice(0,4),i+="<td>"+n[2][0]+" in "+n[2][1].slice(0,4)+d+"</tr>",$("#results_table tbody").append(i),m=addToGraphSeries(n,m,u);l&&$("#results_area tfoot").append("<tr><td colspan=4>+ indicates same value also occurred in a previous year.</tr>"),addGraph(m,u)}function initChangeTable(t,e){var a=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - ");$("#results_area").append('<table id="results_table" style="display:none;"><caption></caption></table>'),$("#results_table caption").append("ThreadEx Record Changes From Version "+t+" to "+("Current"!==e?"Version ":"")+e+" for "+a[1]+" Area, "+a[0]+'<br /><span class="subcaption">Current'+("Current"!==e?" Version "+e+"; ":"; ")+'Period of record: <span id="lsy"></span> - <span id="ley"></span></span><br /><span class="subcaption">Previous Version: '+t+'; Period of record: <span id="psy"></span> - <span id="pey"></span></span>'),$.each({himaxt:"Highest maximum temperature (deg F)",lomint:"Lowest minimum temperature (deg F)",lomaxt:"Lowest maximum temperature (deg F)",himint:"Highest minimum temperature (deg F)",hipcpn:"Highest precipitation (inches)"},function(t,e){$("#results_table").append('<tbody id="'+t+'"></tbody>'),$("#"+t).append('<tr style="background-color:WhiteSmoke;"><th colspan=5>'+e+"</tr>")})}function displayChanges(t,e,a){var r,n,s,i,o,d,l,p;if($("#psy").text(a[0]),$("#pey").text(a[1]),$("#lsy").text(a[2]),$("#ley").text(a[3]),$("#results_table").show(),0===e.length)$("#"+t).append("<tr><td colspan=5>None</tr>");else for($("#"+t).append('<tr style="background-color:WhiteSmoke;"><th>Date<th>Current Record <th>Year <th>Previous Record <th>Year</tr>'),r=0;r<e.length;r+=1)n=e[r][0],i=e[r][2],d=e[r][4],"hipcpn"===n?(s="Trace"===e[r][1]?"Trace":e[r][1].toFixed(2),o="Trace"===e[r][3]?"Trace":e[r][3].toFixed(2)):(s=e[r][1],o=e[r][3]),l=s!==o?"red":"black",p=s===o?"red":"black",$("#"+n).append("<tr><td>"+parseInt(i[1])+"/"+parseInt(i[2])+'<td style="color:'+l+';">'+s+'<td style="color:'+p+';">'+i[0]+"<td>"+o+"<td>"+d[0]+"</tr>");"hipcpn"===t&&$("#progressbar").hide()}function displayThreads(t){var e,a=("None selected"!==$("#selected_station").text()?$("#selected_station").text():$("#thr_id").find(".ui-menu-item[data-value='"+$("#thr_id").val()+"']").text()).split(" - ");for($("#results_area").append('<table id="results_table" class="threads_table"><caption></caption><thead></thead><tbody></tbody></table>'),$("#results_table caption").append("Station Thread for "+a[1]+" Area, "+a[0]),$("#results_table thead").append("<tr><th><th>Name<th>Period in Thread</tr>"),e=0;e<t.length;e+=1)$("#results_table tbody").append("<tr><td>"+(e+1)+"<td>"+t[e].name+"<td>"+t[e].period+"</tr>")}function getCoverage(){postResults({sid:$("#thr_id").val(),sdate:"por",edate:"por",elems:[{name:$("#report").val().slice(-4),interval:"mly",duration:"mly",reduce:{reduce:"cnt_ge_-999",add:"mcnt"},groupby:["year"]}],meta:["name","state","valid_daterange"]},"/StnData",displayCoverage)}function getRecords(){postResults({sid:$("#thr_id").val(),sdate:"por",edate:"por",elems:[{name:$("#report").val().slice(-4),interval:"dly",duration:"dly",smry:{reduce:"hi"===$("#report").val().slice(-6,-4)?"max":"min",add:"date",n:4},smry_only:1,groupby:["year","01-01","12-31"]}],meta:["name","state","valid_daterange"]},"/StnData",displayRecords)}function getArchiveRecords(){var t=$("#thr_id").val(),e=$("#report").val().replace("archive","");$.get("./"+latest_version_directory+"/"+e+"_records.json",function(e){$("#progressbar").hide(),e.hasOwnProperty(t)?displayArchiveRecords(e[t],e.version,e.creationdate):alert("No data available")})}function getChanges(){var t=$("#thr_id").val(),e=9999,a=0,r=9999,n=0;initChangeTable(prev_version_directory.substr(6),latest_version_directory.substr(6)),$.each(["himaxt","lomint","lomaxt","himint","hipcpn"],function(s,i){var o,d,l,p,c,h,u,m=[];$.get("./"+latest_version_directory+"/"+i+"_records.json",function(s){s.hasOwnProperty(t)&&(d=s[t],e=d.start_yr?Math.min(e,parseInt(d.start_yr)):e,a=d.end_yr?Math.max(a,parseInt(d.end_yr)):a,$.get("./"+prev_version_directory+"/"+i+"_records.json",function(s){if(s.hasOwnProperty(t))for(c=s[t],r=Math.min(r,c.start_yr),n=Math.max(n,c.end_yr),o=0;o<366;o+=1)l=d.data[o][0][0],"hipcpn"===i&&-1===l&&(l="Trace"),p=d.data[o][0][1].split("-"),h=c.data[o][0][0],"hipcpn"===i&&-1===h&&(h="Trace"),u=c.data[o][0][1].split("-"),l===h&&p[0]===u[0]||m.push([i,l,p,h,u]);else r="-",n="-";displayChanges(i,m,[r,n,e,a])}))})})}function getRecentChanges(){var t=9999,e=0,a=9999,r=0,n=$("#thr_id").val(),s={sid:n,sdate:"por",edate:"por",elems:[{name:null,interval:"dly",duration:"dly",smry:{reduce:null,add:"date"},smry_only:1,groupby:["year","01-01","12-31"]}],meta:["name","state","valid_daterange"]};initChangeTable(latest_version_directory.substr(6),"Current"),$.each(["himaxt","lomint","lomaxt","himint","hipcpn"],function(i,o){var d,l,p,c,h,u,m=[];$.get("./"+latest_version_directory+"/"+o+"_records.json",function(i){i.hasOwnProperty(n)&&(l=i[n],t=Math.min(t,parseInt(l.start_yr)),e=Math.max(e,parseInt(l.end_yr)),s.elems[0].name=o.slice(-4),s.elems[0].smry.reduce="hi"===o.slice(-6,-4)?"max":"min",postResults(s,"/StnData",function(n){var s=n.meta.valid_daterange[0][0].split("-"),i=n.meta.valid_daterange[0][1].split("-");for(a=Math.min(a,parseInt(s[0])),r=Math.max(r,parseInt(i[0])),d=0;d<366;d+=1)p=l.data[d][0][0],"hipcpn"===o&&-1===p&&(p="Trace"),c=l.data[d][0][1].split("-"),h="hipcpn"===o&&"T"===n.smry[0][d][0]?"Trace":parseFloat(n.smry[0][d][0]),u=n.smry[0][d][1].split("-"),p===h&&c[0]===u[0]||m.push([o,h,u,p,c]);displayChanges(o,m,[t,e,a,r])}))})})}function getThreads(){var t=$("#thr_id").val().replace("thr","");$.get("./data/threads_dict.json",function(e){$("#progressbar").hide(),displayThreads(e[t])})}$(function(){var t=function(t,e){var a=$(this).prev("button");if(e.item.attr("class").search("noselect")>=0)return $(this).trigger("click"),!1;a.show().text(a.text().replace("Select","Change")),$(this).val(e.item.data("value")).hide(),$(this).parent().find("span").html(e.item.text()),$("#results_area").empty()};$("#thr_id").val("BHMthr").menu({select:t}),$("#report").val("thread").menu({items:"> :not(.ui-widget-header)",select:t}),$(".show_menu").button().on("click",function(){$(this).next("ul").show(),$(this).prev("span").empty(),$(this).hide()}),$("#go").button().on("click",function(){var t=$("#report").val();$("#results_area").empty(),$("#progressbar").show(),$.inArray(t,["himaxt","lomaxt","himint","lomint","hipcpn"])>=0?getRecords():$.inArray(t,["archivehimaxt","archivelomaxt","archivehimint","archivelomint","archivehipcpn"])>=0?getArchiveRecords():"changes"===t?getChanges():"recentchanges"===t?getRecentChanges():$.inArray(t,["covmaxt","covmint","covpcpn"])>=0?getCoverage():"thread"===t?getThreads():($("#results_area").append("<p>Selection not implemented</p>"),$("#progressbar").hide())}),$("#progressbar").progressbar({value:!1,disabled:!0}),$("#info").dialog({autoOpen:!1,modal:!0,width:.9*$(window).width(),maxHeight:.9*$(window).height(),position:{my:"center top",at:"center top",of:$("div.option-container")},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]}),$("#about").button().on("click",function(){$("#info").load("./help/about.html").dialog("option","title","Project Information").dialog("open")}),$("#report_info").on("click",function(){$("#info").load("./help/report_help.html").dialog("option","title","Report Options").dialog("open")}),$.ui.dialog.prototype._focusTabbable=$.noop;var e=urlopts();"thr_id"in e&&"variable"in e&&(e.thr_id=e.thr_id.substr(0,e.thr_id.length-3).toUpperCase()+e.thr_id.substr(e.thr_id.length-3).toLowerCase(),$("#thr_id").val(e.thr_id),$("#selected_station").text($("#thr_id li[data-value="+e.thr_id+"]").text()),e.variable=e.variable.toLowerCase(),$("#report").val(e.variable),$("#selected_report").text($("#report li[data-value="+e.variable+"]").text()),$("#go").trigger("click"))});